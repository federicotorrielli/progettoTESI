<html>
<head>
    <meta charset="UTF-8">
    <script src='https://code.jquery.com/jquery-3.4.1.min.js' type='text/javascript'></script>
    <link href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" rel="stylesheet"/>
    <link href="//cdn.muicss.com/mui-0.10.1/css/mui.min.css" rel="stylesheet"/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" type="text/javascript"></script>
    <link href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" rel="stylesheet"/>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"
            type="text/javascript"></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <style media="screen">
        #map {
            width: 100%;
            height: 100%
        }
    </style>
    <title>Mappa di Torino</title>
</head>
<body>
<div id="map"></div>
<div class="leaflet-top leaflet-right" style="pointer-events: auto">
    <button class="mui-btn mui-btn--primary leaflet-clickable" id="bottone1" onclick="buttonPressedMap();">Attiva
        Funzione
    </button>
</div>
<script type="text/javascript">
    let buttonPressed = false;
    let circleLayer = undefined;
    let circleFigure = undefined;

    let map = L.map('map', {
        center: [45.0709823, 7.6777233],
        minZoom: 2,
        zoom: 15
    });

    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        subdomains: ['a', 'b', 'c']
    }).addTo(map);

    function clickHandler(e) {
        if (circleLayer !== undefined && circleFigure !== undefined)
            removalHandler(circleFigure, true);
        circleFigure = e.layer;
        circleFigure.on('pm:dragend', ev => editHandler(ev));
        $.get("https://beta.ontomap.ontomap.eu/features?lat=" + e.layer.getLatLng().lat + "&lng=" + e.layer.getLatLng().lng + "&maxDistance=" + e.layer.getRadius(), function (geoJsonFeature) {
            geoJsonFeature.features.forEach((item, i) => {
                let circle = turf.circle([e.layer.getLatLng().lng, e.layer.getLatLng().lat], e.layer.getRadius() / 1000);
                let intersect = turf.intersect(circle, item);
                circleLayer = L.geoJSON(intersect, {
                    onEachFeature(feature, layer) {
                        layer.bindPopup(L.popup({maxHeight: 200}, layer).setContent(item.properties.label));
                        layer.myTag = "circleLayer";
                    }
                });
                circleLayer.addTo(map);
            });
        });
    }

    function buttonPressedMap() {
        buttonPressed = !buttonPressed;
        map.pm.addControls({
            position: 'topleft',
            drawMarker: false,
            drawPolyline: false,
            drawRectangle: false,
            drawPolygon: false,
            drawCircleMarker: false,
            drawCircle: true,
            editMode: true,
            dragMode: true,
            removalMode: true,
            cutPolygon: false,
        });
        map.pm.setLang('it');
        if (buttonPressed)
            document.getElementById("bottone1").innerText = "Disattiva Funzione";
        else {
            map.pm.addControls({
                position: 'topleft',
                drawMarker: false,
                drawPolyline: false,
                drawRectangle: false,
                drawPolygon: false,
                drawCircleMarker: false,
                drawCircle: false,
                editMode: false,
                dragMode: false,
                removalMode: false,
                cutPolygon: false,
            });
            document.getElementById("bottone1").innerText = "Attiva Funzione";
        }
    }

    function removalHandler(circle, bool) {
        map.eachLayer(function (layer) {
            if (layer.myTag && layer.myTag === "circleLayer")
                map.removeLayer(layer);
        });
        if (bool)
            map.removeLayer(circle);
    }

    function editHandler(e) {
        if (circleLayer !== undefined && circleFigure !== undefined)
            removalHandler(circleFigure, false);
        circleFigure = e.target;
        $.get("https://beta.ontomap.ontomap.eu/features?lat=" + e.target.getLatLng().lat + "&lng=" + e.target.getLatLng().lng + "&maxDistance=" + e.target.getRadius(), function (geoJsonFeature) {
            geoJsonFeature.features.forEach((item, i) => {
                let circle = turf.circle([e.target.getLatLng().lng, e.target.getLatLng().lat], e.target.getRadius() / 1000);
                let intersect = turf.intersect(circle, item);
                circleLayer = L.geoJSON(intersect, {
                    onEachFeature(feature, layer) {
                        layer.bindPopup(L.popup({maxHeight: 200}, layer).setContent(item.properties.label));
                        layer.myTag = "circleLayer";
                    }
                });
                circleLayer.addTo(map);
            });
        });
    }

    map.on('pm:create', e => clickHandler(e));
    map.on('pm:remove', e => removalHandler(e));
</script>
</body>
</html>
