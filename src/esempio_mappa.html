<html>
<head>
    <meta charset="UTF-8">
    <script src='https://code.jquery.com/jquery-3.4.1.min.js' type='text/javascript'></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/leaflet.css" rel="stylesheet"/>
    <link href="//cdn.muicss.com/mui-0.10.1/css/mui.min.css" rel="stylesheet"/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" type="text/javascript"></script>
    <link href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" rel="stylesheet"/>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"
            type="text/javascript"></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src="https://unpkg.com/leaflet-responsive-popup@0.6.4/leaflet.responsive.popup.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.css"
          rel="stylesheet"/>
    <link href="https://unpkg.com/leaflet-responsive-popup@0.6.4/leaflet.responsive.popup.css" rel="stylesheet"/>
    <style media="screen">
        #map {
            width: 100%;
            height: 100%
        }
    </style>
    <title>Mappa di Torino</title>
</head>
<body>
<div id="map"></div>
<div class="leaflet-top leaflet-right" style="pointer-events: auto">
    <button class="mui-btn mui-btn--primary leaflet-clickable" id="bottone1" onclick="buttonPressedMap();">Attiva
        Funzione
    </button>
</div>
<script type="text/javascript">
    let buttonPressed = false;
    let circleLayer = undefined;
    let circleFigure = undefined;
    let specialMarkerList = new Map();

    let map = L.map('map', {
        center: [45.0709823, 7.6777233],
        minZoom: 2,
        zoom: 15
    });

    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        subdomains: ['a', 'b', 'c']
    }).addTo(map);

    function clickHandler(e) {
        if (e.layer.getRadius() > 400) {
            attivaToast("Il cerchio Ã¨ troppo grande, riprova!", "error", "#e74c3c");
            map.removeLayer(e.layer)
            return;
        }

        if (circleLayer !== undefined && circleFigure !== undefined)
            removalHandler(circleFigure, true);

        circleFigure = e.layer;
        circleFigure.on('pm:dragend', ev => editHandler(ev));

        $.get("https://beta.ontomap.ontomap.eu/features?lat=" + e.layer.getLatLng().lat + "&lng=" + e.layer.getLatLng().lng + "&maxDistance=" + e.layer.getRadius(), function (geoJsonFeature) {
            let mappaColori = new Map();
            geoJsonFeature.features.forEach((item, i) => {
                $.get("https://beta.ontomap.ontomap.eu/concepts/" + item.properties.otmClass + "/info",
                    function (value) {
                        mappaColori.set(item.properties.label, value);
                    }
                );
            });

            geoJsonFeature.features.forEach((item, i) => {
                let circle = turf.circle([e.layer.getLatLng().lng, e.layer.getLatLng().lat], e.layer.getRadius() / 1000);
                let intersect = turf.intersect(circle, item);
                circleLayer = L.geoJSON(intersect, {
                    onEachFeature(feature, layer) {
                        let link = $('<div id="test"><b>' + item.properties.label + '</b></div>').append($('<img src="http://fusione22.altervista.org/images/iconfinder_star_285661.svg" alt="Salva posizione">').click(function () {
                            if (layer.myTag !== "favorite") {
                                layer.myTag = "favorite";
                                if (layer.options.color !== undefined) {
                                    specialMarkerList.set(item.properties.label,new L.marker(layer.getLatLngs()[0][0], {
                                        icon: new L.Icon({
                                            iconUrl: 'http://fusione22.altervista.org/images/marker-icon-starred.png',
                                            iconSize: [25, 41],
                                            iconAnchor: [12, 40],
                                            popupAnchor: [1, -38],
                                        }), title: item.properties.label
                                    }).addTo(map));
                                    layer.setStyle({
                                        color: mappaColori.get(item.properties.label).color,
                                        fillOpacity: 0.9
                                    });
                                } else
                                    layer.setIcon(new L.Icon({
                                        iconUrl: 'http://fusione22.altervista.org/images/marker-icon-starred.png',
                                        iconSize: [25, 41],
                                        iconAnchor: [12, 40],
                                        popupAnchor: [1, -38],
                                    }));
                                attivaToast("Posizione salvata", "info", "#2980b9");
                            } else {
                                layer.myTag = "circleLayer";
                                if (layer.options.color !== undefined) {
                                    layer.setStyle({color: "#3388ff", fillOpacity: 0.2});
                                    map.removeLayer(specialMarkerList.get(item.properties.label));
                                    specialMarkerList.delete(item.properties.label);
                                } else
                                    layer.setIcon(new L.Icon({
                                        iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/images/marker-icon.png',
                                    }));
                                attivaToast("Posizione cancellata", "info", "#e74c3c");
                            }
                        }))[0];
                        if (layer.myTag === undefined)
                            layer.myTag = "circleLayer";
                        layer.bindPopup(L.responsivePopup({maxHeight: 200}, layer).setContent(link));
                    }
                });
                circleLayer.addTo(map);
            });
        });
    }

    function buttonPressedMap() {
        buttonPressed = !buttonPressed;
        map.pm.addControls({
            position: 'topleft',
            drawMarker: false,
            drawPolyline: false,
            drawRectangle: false,
            drawPolygon: false,
            drawCircleMarker: false,
            drawCircle: true,
            editMode: true,
            dragMode: true,
            removalMode: true,
            cutPolygon: false,
        });
        map.pm.setLang('it');
        if (buttonPressed)
            document.getElementById("bottone1").innerText = "Disattiva Funzione";
        else {
            map.pm.addControls({
                position: 'topleft',
                drawMarker: false,
                drawPolyline: false,
                drawRectangle: false,
                drawPolygon: false,
                drawCircleMarker: false,
                drawCircle: false,
                editMode: false,
                dragMode: false,
                removalMode: false,
                cutPolygon: false,
            });
            document.getElementById("bottone1").innerText = "Attiva Funzione";
        }
    }

    function removalHandler(circle, bool) {
        map.eachLayer(function (layer) {
            if (layer.myTag && layer.myTag === "circleLayer")
                map.removeLayer(layer);
        });
        if (bool)
            map.removeLayer(circle);
    }

    function editHandler(e) {
        if (circleLayer !== undefined && circleFigure !== undefined)
            removalHandler(circleFigure, false);

        circleFigure = e.target;
        $.get("https://beta.ontomap.ontomap.eu/features?lat=" + e.target.getLatLng().lat + "&lng=" + e.target.getLatLng().lng + "&maxDistance=" + e.target.getRadius(), function (geoJsonFeature) {
            let mappaColori = new Map();
            geoJsonFeature.features.forEach((item, i) => {
                $.get("https://beta.ontomap.ontomap.eu/concepts/" + item.properties.otmClass + "/info",
                    function (value) {
                        mappaColori.set(item.properties.label, value);
                    }
                );
            });

            geoJsonFeature.features.forEach((item, i) => {
                let circle = turf.circle([e.target.getLatLng().lng, e.target.getLatLng().lat], e.target.getRadius() / 1000);
                let intersect = turf.intersect(circle, item);
                circleLayer = L.geoJSON(intersect, {
                    onEachFeature(feature, layer) {
                        let link = $('<div id="test"><b>' + item.properties.label + '</b></div>').append($('<img src="http://fusione22.altervista.org/images/iconfinder_star_285661.svg" alt="Salva posizione">').click(function () {
                            if (layer.myTag !== "favorite") {
                                layer.myTag = "favorite";
                                if (layer.options.color !== undefined) {
                                    specialMarkerList.set(item.properties.label,new L.marker(layer.getLatLngs()[0][0], {
                                        icon: new L.Icon({
                                            iconUrl: 'http://fusione22.altervista.org/images/marker-icon-starred.png',
                                            iconSize: [25, 41],
                                            iconAnchor: [12, 40],
                                            popupAnchor: [1, -38],
                                        }), title: item.properties.label
                                    }).addTo(map));
                                    layer.setStyle({
                                        color: mappaColori.get(item.properties.label).color,
                                        fillOpacity: 0.9
                                    });
                                } else
                                    layer.setIcon(new L.Icon({
                                        iconUrl: 'http://fusione22.altervista.org/images/marker-icon-starred.png',
                                        iconSize: [25, 41],
                                        iconAnchor: [12, 40],
                                        popupAnchor: [1, -38],
                                    }));
                                attivaToast("Posizione salvata", "info", "#2980b9");
                            } else {
                                layer.myTag = "circleLayer";
                                if (layer.options.color !== undefined) {
                                    layer.setStyle({color: "#3388ff", fillOpacity: 0.2});
                                    map.removeLayer(specialMarkerList.get(item.properties.label));
                                    specialMarkerList.delete(item.properties.label);
                                } else
                                    layer.setIcon(new L.Icon({
                                        iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/images/marker-icon.png',
                                    }));
                                attivaToast("Posizione cancellata", "info", "#e74c3c");
                            }
                        }))[0];
                        if (layer.myTag === undefined)
                            layer.myTag = "circleLayer";
                        layer.bindPopup(L.responsivePopup({maxHeight: 200}, layer).setContent(link));
                    }
                });
                circleLayer.addTo(map);
            });
        });
    }

    function attivaToast(dati, cond, bgColor) {
        $.toast({
            text: dati,
            heading: 'Avviso',
            icon: cond,
            showHideTransition: 'fade',
            allowToastClose: true,
            hideAfter: 3000,
            stack: 5,
            position: 'bottom-left',
            textAlign: 'left',
            loader: true,
            loaderBg: '#9EC600',
            bgColor: bgColor,
        });
    }

    map.on('pm:create', e => clickHandler(e));
    map.on('pm:remove', e => removalHandler(e));
</script>
</body>
</html>
