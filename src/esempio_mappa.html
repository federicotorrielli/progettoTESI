<html>
<head>
    <script src='https://code.jquery.com/jquery-3.4.1.min.js' type='text/javascript'></script>
    <link href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" rel="stylesheet"/>
    <link href="//cdn.muicss.com/mui-0.10.1/css/mui.min.css" rel="stylesheet"/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" type="text/javascript"></script>
    <link href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" rel="stylesheet"/>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"
            type="text/javascript"></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <style media="screen">
        #map {
            width: 100%;
            height: 100%
        }
    </style>
    <title>Mappa di Torino</title>
</head>
<body>
<div id="map"></div>
<div class="leaflet-top leaflet-right" style="pointer-events: auto">
    <button block class="mui-btn mui-btn--primary leaflet-clickable" id="bottone1" onclick="buttonPressedMap();">Attiva
        Funzione
    </button>
</div>
<script type="text/javascript">
    let buttonPressed = false;

    let map = L.map('map', {
        center: [45.0709823, 7.6777233],
        minZoom: 2,
        zoom: 15
    });

    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        subdomains: ['a', 'b', 'c']
    }).addTo(map);
    $.get("https://beta.ontomap.ontomap.eu/features?lat=45.0709823&lng=7.6777233&maxDistance=400&minDistance=300", function (geojsonFeature) {
        L.geoJSON(geojsonFeature, {
            onEachFeature(feature, layer) {
                layer.bindPopup(L.popup({maxHeight: 200}, layer).setContent(feature.properties.label));
            }
        }).addTo(map);
    });

    function clickHandler(e) {
        console.log(e.layer._latlng);
        console.log(e.layer._mRadius);
        console.log(e);
        $.get("https://beta.ontomap.ontomap.eu/features?lat=" + e.layer.getLatLng().lat + "&lng=" + e.layer.getLatLng().lng + "&maxDistance=" + e.layer.getRadius(), function (geoJsonFeature) {
            geoJsonFeature.features.forEach((item, i) => {
                let circle = turf.circle([e.layer.getLatLng().lng,e.layer.getLatLng().lat],  e.layer.getRadius()/1000);
                let intersect =  turf.intersect(circle,item);
                L.geoJSON(intersect, {
                    onEachFeature(feature, layer) {
                        layer.bindPopup(L.popup({maxHeight: 200}, layer).setContent(item.properties.label));
                    }
                }).addTo(map)
            });
        });
    }

    function buttonPressedMap() {
        buttonPressed = !buttonPressed;
        map.pm.addControls({
            position: 'topleft',
            drawMarker: false,
            drawPolyline: false,
            drawRectangle: false,
            drawPolygon: false,
            cutPolygon: false,
        });
        map.pm.setLang('it');
        if (buttonPressed)
            document.getElementById("bottone1").innerText = "Disattiva Funzione";
        else
            document.getElementById("bottone1").innerText = "Attiva Funzione";
    }

    map.on('pm:create', e => clickHandler(e));
</script>
</body>
</html>
